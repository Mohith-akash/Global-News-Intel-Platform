name: 15-Min GDELT Refresh (Polars + GE)

on:
  schedule:
    # Runs every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Manual trigger

jobs:
  refresh-data:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Set up Python with caching
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    # 3. Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. Run Dagster Pipeline (Polars-powered)
    - name: Execute Dagster Job (Polars)
      env:
        MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
      run: |
        echo "ðŸš€ Starting GDELT Ingestion (Polars + Great Expectations)..."
        python -m dagster job execute -f etl/pipeline_polars.py -j gdelt_ingestion_job
        echo "âœ… Data Refresh Complete."

    # 5. Keep Streamlit app awake (Playwright browser automation)
    - name: Keep Streamlit Alive (Playwright)
      run: |
        pip install playwright
        playwright install chromium
        python << 'EOF'
        import asyncio
        from playwright.async_api import async_playwright

        async def keep_alive():
            print("ðŸ”„ Starting Playwright browser...")
            async with async_playwright() as p:
                browser = await p.chromium.launch(headless=True)
                page = await browser.new_page()
                
                try:
                    # Navigate to the app
                    print("ðŸ“¡ Connecting to Streamlit app...")
                    await page.goto("https://global-news-intel-platform.streamlit.app/", 
                                    wait_until="domcontentloaded", timeout=60000)
                    
                    # Check if app is sleeping (look for wake button)
                    await asyncio.sleep(3)
                    content = await page.content()
                    
                    if "Zzzz" in content or "gone to sleep" in content:
                        print("ðŸ˜´ App is sleeping! Attempting to wake...")
                        # Try to click the wake button
                        try:
                            wake_btn = page.get_by_text("Yes, get this app back up!")
                            await wake_btn.click(timeout=5000)
                            print("ðŸ”˜ Clicked wake button, waiting for app to start...")
                            await page.wait_for_timeout(30000)  # Wait 30s for app to wake
                            print("âœ… Wake request sent!")
                        except Exception as e:
                            print(f"âš ï¸  Could not click wake button: {e}")
                    else:
                        # App is awake - wait a bit to establish WebSocket connection
                        print("âœ… App is awake! Establishing connection...")
                        await page.wait_for_timeout(10000)  # Stay connected for 10s
                        print("âœ… Keep-alive complete - WebSocket connection established")
                    
                except Exception as e:
                    print(f"âš ï¸  Error: {e}")
                finally:
                    await browser.close()

        asyncio.run(keep_alive())
        EOF
